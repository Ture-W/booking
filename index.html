<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2 id="title">Boka snabbt</h2>
  <div id="content">
    <form id="booking-form">
      <div class="input-container" id="credentials-input">
        <label for="hh-username">HH Användarnamn:</label><br>
        <input class="text-input input-field" type="text" id="hh-username" placeholder="föreft23@student.hh.se" required><br>
        <label for="hh-password">HH Lösenord:</label><br>
        <input class="text-input input-field" type="password" id="hh-password" placeholder="lösenord" required>
        <p id="credentials-info">* DENNA GITHUB SIDAN ÄR OPEN SOURCE. Du kan läsa källkoden <a href="https://github.com/Ture-W/booking">här</a> för att se 
          exakt vad som händer med inloggningsuppgifterna. Använd ändå bara denna sidan om du litar på mig. 
          Alternativt kan du köra python filen själv, den finns bland källkoden.</p>
      </div>
      <div class="input-container" id="booking-input">
        <label for="room-name">Namn på rummet:</label><br>
        <input class="text-input input-field" type="text" id="room-name" placeholder="s1016" required><br>

        <label for="start-hour">Tid att boka (timme:minut):</label>
        <div id="time-input">
          <input class="input-field" type="number" id="start-hour" placeholder="13" min="0" max="23" required>
          <span>:</span>
          <input class="input-field" type="number" id="start-minute" placeholder="0" min="0" max="59" required>
        </div>

        <label>Tidslängd:</label><br>
        <div class="duration-radio">
          <input type="radio" name="duration" value="30">
          <input type="radio" name="duration" value="60">
          <input type="radio" name="duration" value="80">
          <input type="radio" name="duration" value="120" checked>
          <input type="radio" name="duration" value="180">
        </div>
      </div>
      <button type="submit" id="book-room">Boka</button>
    </form>
  </div>

  <p id="output"></p>

  <script src="./index.js"></script>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function waitUntil(hour, minute, second = 0) {
      while (true) {
        const now = new Date();
        const currentHour = now.getUTCHours();
        const currentMinute = now.getUTCMinutes();
        const currentSecond = now.getUTCSeconds();
        if (currentHour > hour || (currentHour === hour && currentMinute > minute) || (currentHour === hour && currentMinute === minute && currentSecond >= second)) {
          break;
        }
        await sleep(30000);
      }
    }

    async function bookRoomProcess() {
      const roomName = $('#room-name').val();
      const startHour = parseInt($('#start-hour').val());
      const startMinute = parseInt($('#start-minute').val());
      const duration = $('input[name="duration"]:checked').val();
      const hhUsername = $('#hh-username').val();
      const hhPassword = $('#hh-password').val();

      await waitUntil(5, 52);

      const poiId = await getPoi(roomName);
      if (!poiId) {
        $('#output').text('Kunde inte hitta rummet "'+roomName+'".');
        return;
      }

      // Detta väcker upp Render web servicen, tidigast 8 minuter innan bokning för bra marginal
      const token = await getToken(hhUsername, hhPassword);
      if (!token) {
        $('#output').text("Fell uppstod under verifiering av inloggningsuppgifter. Kontrollera HH inloggningsuppgifterna.");
        return;
      }

      // Säger till backend att boka några sekunder tidigt för att bokningen ska ske så nära kl 08:00 som möjligt
      await waitUntil(5, 59, 55);

      const booking = await bookRoom(poiId, startHour, startMinute, duration, token);

      if (booking.success) {
        $('#output').text("Lyckades boka rummet!");
      } else {
        const errorMessage = parseBookingError(booking.error);
        $('#output').html(`Fel uppstod: "${booking.error}"<br><br>${errorMessage}`);
      }

    }

    $(document).ready(function() {

      $('#start-hour').on('input', function() {
        if ($(this).val().length == 2) {
          $('#start-minute').focus();
        }
      });
      $('#start-minute').on('input', function() {
        if ($(this).val().length == 0) {
          $('#start-hour').focus();
        }
      });

      $('#booking-form').on('submit', function(event) {
        event.preventDefault()
        bookRoomProcess();
      });

    });

  </script>
</body>
</html>
