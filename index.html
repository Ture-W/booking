<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script
  src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
</head>
<body>
  <h2>Room Booking</h2>
  <form id="bookingForm">
    <label for="room_name">Room Name:</label>
    <input type="text" id="room_name" value="s1016"><br><br>

    <label for="start_hour">Booking Start Time (Hour):</label>
    <input type="number" id="start_hour" value="12" min="0" max="23"><br><br>

    <label for="start_minute">Booking Start Time (Minute):</label>
    <input type="number" id="start_minute" value="15" min="0" max="59"><br><br>

    <label for="duration">Duration (Hours):</label>
    <input type="number" id="duration" value="2" min="0"><br><br>

    <label for="hh_username">HH Username:</label>
    <input type="text" id="hh_username" value="name"><br><br>

    <label for="hh_password">HH Password:</label>
    <input type="password" id="hh_password" value="pass"><br><br>

    <button type="button" id="bookRoom">Book Room</button>
  </form>

  <p id="output"></p>

  <script src="./index.js"></script>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function waitUntil(hour, minute, second = 0) {
      while (true) {
        const now = new Date();
        const currentHour = now.getUTCHours();
        const currentMinute = now.getUTCMinutes();
        const currentSecond = now.getUTCSeconds();
        if (currentHour > hour || (currentHour === hour && currentMinute > minute) || (currentHour === hour && currentMinute === minute && currentSecond >= second)) {
          break;
        }
        await sleep(30000);
      }
    }

    async function bookRoomProcess() {
      const roomName = $('#room_name').val();
      const startHour = parseInt($('#start_hour').val());
      const startMinute = parseInt($('#start_minute').val());
      const duration = parseInt($('#duration').val());
      const hhUsername = $('#hh_username').val();
      const hhPassword = $('#hh_password').val();

      await waitUntil(5, 52);

      const poiId = await getPoi(roomName);
      if (!poiId) {
        $('#output').text('Kunde inte hitta rummet "'+roomName+'".');
        return;
      }

      // Detta väcker upp Render web servicen, tidigast 8 minuter innan bokning för bra marginal
      const token = await getToken(hhUsername, hhPassword);
      if (!token) {
        $('#output').text("Fell uppstod under verifiering av inloggningsuppgifter. Kontrollera HH inloggningsuppgifterna.");
        return;
      }

      // Säger till backend att boka några sekunder tidigt för att bokningen ska ske så nära kl 08:00 som möjligt
      await waitUntil(5, 59, 55);

      const booking = await bookRoom(poiId, startHour, startMinute, duration, token);

      if (booking.success) {
        $('#output').text("Lyckades boka rummet!");
      } else {
        const errorMessage = parseBookingError(booking.error);
        $('#output').html(`Fel uppstod: "${booking.error}"<br><br>${errorMessage}`);
      }

    }

    $('#bookRoom').on('click', function() {
      bookRoomProcess();
    });

  </script>
</body>
</html>
